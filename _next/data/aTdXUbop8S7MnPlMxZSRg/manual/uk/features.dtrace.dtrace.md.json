{"pageProps":{"page":{"slug":"features.dtrace.dtrace.md","content":"## Використання PHP та DTrace\n\nPHP може бути налаштований зі статичними зондами DTrace на платформах, що підтримують динамічне трасування DTrace.\n\n### Конфігурування PHP із статичними зондами DTrace\n\nЗверніться до документації вашої платформи, щоб увімкнути підтримку DTrace у вашій операційній системі. Наприклад, в Oracle Linux необхідно завантажити ядро ​​UEK3 і зробити таке:\n\n```php\n# modprobe fasttrap\n# chmod 666 /dev/dtrace/helper\n```\n\nЗамість `chmod`, Ви можете використовувати пакет правил ACL для обмеження доступу для конкретного користувача.\n\nСкладання PHP з ключем `--enable-dtrace` :\n\n```php\n# ./configure --enable-dtrace ...\n# make\n# make install\n```\n\nЦе включає статичні зонди в ядрі PHP. Будь-який модуль PHP, що надає власні зонди, повинен бути зібраний окремо як модуль, що розділяється.\n\n### Статичні зонди DTrace у ядрі PHP\n\n**Наступні статичні зонди доступні в PHP**\n\n| Имя зонда | Опис зонда | Аргументы зонда |\n| --- | --- | --- |\n| `request-startup` | Спрацьовує на початку запиту. | char \\*file, char \\*request\\_uri, char \\*request\\_method |\n| `request-shutdown` | Спрацьовує після закінчення запиту. | char \\*file, char \\*request\\_uri, char \\*request\\_method |\n| `compile-file-entry` | Спрацьовує, коли розпочинається компіляція скрипту. | char \\*compile\\_file, char \\*compile\\_file\\_translated |\n| `compile-file-return` | Спрацьовує, коли закінчується компіляція скрипту. | char \\*compile\\_file, char \\*compile\\_file\\_translated |\n| `execute-entry` | Спрацьовує, коли запускається масив байт-коду. Наприклад, коли викликаються функції, відновлюється робота генератора чи відбувається include. | char \\*request\\_file, int lineno |\n| `execute-return` | Спрацьовує після відпрацювання масиву байт-коду. | char \\*request\\_file, int lineno |\n| `function-entry` | Спрацьовує, коли PHP починає запуск функції або методу. | char \\*function\\_name, char \\*request\\_file, int lineno, char \\*classname, char \\*scope |\n| `function-return` | Спрацьовує, коли PHP повертається з функції або методу. | char \\*function\\_name, char \\*request\\_file, int lineno, char \\*classname, char \\*scope |\n| `exception-thrown` | Спрацьовує, коли викинуто виняток. | char \\*classname |\n| `exception-caught` | Спрацьовує, коли виняток спійманий. | char \\*classname |\n| `error` | Спрацьовує, якщо сталася помилка, незалежно від рівня [error\\_reporting](errorfunc.configuration.md#ini.error-reporting) | char \\*errormsg, char \\*request\\_file, int lineno |\n\nМодулі PHP можуть мати додаткові зонди.\n\n### Список статичних зондів DTrace у PHP\n\nЩоб отримати список зондів, запустіть процес PHP і виконайте:\n\n```\n# dtrace -l\n```\n\nВисновок буде приблизно такий:\n\n```\nID   PROVIDER            MODULE                          FUNCTION NAME\n   [ . . . ]\n    4   php15271               php               dtrace_compile_file compile-file-entry\n    5   php15271               php               dtrace_compile_file compile-file-return\n    6   php15271               php                        zend_error error\n    7   php15271               php  ZEND_CATCH_SPEC_CONST_CV_HANDLER exception-caught\n    8   php15271               php     zend_throw_exception_internal exception-thrown\n    9   php15271               php                 dtrace_execute_ex execute-entry\n   10   php15271               php           dtrace_execute_internal execute-entry\n   11   php15271               php                 dtrace_execute_ex execute-return\n   12   php15271               php           dtrace_execute_internal execute-return\n   13   php15271               php                 dtrace_execute_ex function-entry\n   14   php15271               php                 dtrace_execute_ex function-return\n   15   php15271               php              php_request_shutdown request-shutdown\n   16   php15271               php               php_request_startup request-startup\n```\n\nКолонка Provider містить напис `php` та pid поточного запущеного процесу PHP.\n\nЯкщо запущено веб-сервер Apache, ім'я модуля може бути, наприклад, libphp5.so, і може бути безліч блоків списку по одному на кожен процес Apache.\n\nКолонка Function посилається на ім'я внутрішньої функції PHP, що реалізує відповідний зонд.\n\nЯкщо PHP не запущено, то пов'язаних з ним зондів у списку не буде.\n\n### Приклади використання DTrace із PHP\n\nЦей приклад показує основні можливості скриптової мови DTrace D.\n\n**Приклад #1 all\\_probes.d - трасування всіх статичних зондів PHP за допомогою DTrace**\n\n```\n#!/usr/sbin/dtrace -Zs\n\n#pragma D option quiet\n\nphp*:::compile-file-entry\n{\n    printf(\"PHP compile-file-entry\\n\");\n    printf(\"  compile_file              %s\\n\", copyinstr(arg0));\n    printf(\"  compile_file_translated   %s\\n\", copyinstr(arg1));\n}\n\nphp*:::compile-file-return\n{\n    printf(\"PHP compile-file-return\\n\");\n    printf(\"  compile_file              %s\\n\", copyinstr(arg0));\n    printf(\"  compile_file_translated   %s\\n\", copyinstr(arg1));\n}\n\nphp*:::error\n{\n    printf(\"PHP error\\n\");\n    printf(\"  errormsg                  %s\\n\", copyinstr(arg0));\n    printf(\"  request_file              %s\\n\", copyinstr(arg1));\n    printf(\"  lineno                    %d\\n\", (int)arg2);\n}\n\nphp*:::exception-caught\n{\n    printf(\"PHP exception-caught\\n\");\n    printf(\"  classname                 %s\\n\", copyinstr(arg0));\n}\n\nphp*:::exception-thrown\n{\n    printf(\"PHP exception-thrown\\n\");\n    printf(\"  classname                 %s\\n\", copyinstr(arg0));\n}\n\nphp*:::execute-entry\n{\n    printf(\"PHP execute-entry\\n\");\n    printf(\"  request_file              %s\\n\", copyinstr(arg0));\n    printf(\"  lineno                    %d\\n\", (int)arg1);\n}\n\nphp*:::execute-return\n{\n    printf(\"PHP execute-return\\n\");\n    printf(\"  request_file              %s\\n\", copyinstr(arg0));\n    printf(\"  lineno                    %d\\n\", (int)arg1);\n}\n\nphp*:::function-entry\n{\n    printf(\"PHP function-entry\\n\");\n    printf(\"  function_name             %s\\n\", copyinstr(arg0));\n    printf(\"  request_file              %s\\n\", copyinstr(arg1));\n    printf(\"  lineno                    %d\\n\", (int)arg2);\n    printf(\"  classname                 %s\\n\", copyinstr(arg3));\n    printf(\"  scope                     %s\\n\", copyinstr(arg4));\n}\n\nphp*:::function-return\n{\n    printf(\"PHP function-return\\n\");\n    printf(\"  function_name             %s\\n\", copyinstr(arg0));\n    printf(\"  request_file              %s\\n\", copyinstr(arg1));\n    printf(\"  lineno                    %d\\n\", (int)arg2);\n    printf(\"  classname                 %s\\n\", copyinstr(arg3));\n    printf(\"  scope                     %s\\n\", copyinstr(arg4));\n}\n\nphp*:::request-shutdown\n{\n    printf(\"PHP request-shutdown\\n\");\n    printf(\"  file                      %s\\n\", copyinstr(arg0));\n    printf(\"  request_uri               %s\\n\", copyinstr(arg1));\n    printf(\"  request_method            %s\\n\", copyinstr(arg2));\n}\n\nphp*:::request-startup\n{\n    printf(\"PHP request-startup\\n\");\n    printf(\"  file                      %s\\n\", copyinstr(arg0));\n    printf(\"  request_uri               %s\\n\", copyinstr(arg1));\n    printf(\"  request_method            %s\\n\", copyinstr(arg2));\n}\n```\n\nЦей скрипт використовує опцію `-Z` для dtrace, дозволяючи йому працювати навіть якщо жодного процесу PHP не запущено. Якщо не використовувати цю опцію, то скрипт відразу завершить виконання, оскільки не побачить жодного зонда, який йому треба відстежувати.\n\nСкрипт відстежує всі статичні зонди PHP протягом усього роботи PHP-скрипту. Запускаємо D-скрипт:\n\n```\n# ./all_probes.d\n```\n\nЗапустіть скрипт або програму PHP. Відстежуючий D-скрипт виводитиме аргументи всіх зондів, що спрацювали.\n\nКоли ви побачили все, що хотіли, можна перервати роботу скрипта комбінацією CTRL+C.\n\nНа багатопроцесорних машинах порядок зондів може бути не послідовним, залежно від того, на яких процесорах працюють зонди і як мігрують потоки між процесорами. Відображення тимчасових міток дозволить уникнути конфузів. Наприклад:\n\n```\nphp*:::function-entry\n{\n      printf(\"%lld: PHP function-entry \", walltimestamp);\n      [ . . .]\n}\n```\n\n### Дивіться також\n\n-   [OCI8 та динамічне трасування DTrace](oci8.dtrace.md)\n","title":"Використання PHP та DTrace","contentType":2,"navigation":[{"features.dtrace.introduction.md":"« Введення в PHP та DTrace"},{"features.dtrace.systemtap.md":"Використання SystemTap із статичними зондами PHP DTrace »"},{"index.md":"PHP Manual"},{"features.dtrace.md":"Динамічна трасування DTrace"}]}},"__N_SSG":true}