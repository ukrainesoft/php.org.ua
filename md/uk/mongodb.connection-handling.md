- [« Архітектура](mongodb.overview.md)
- [Постійні дані »](mongodb.persistence.md)

- [PHP Manual](index.md)
- [Архітектура та внутрішній пристрій
драйвера](mongodb.architecture.md)
- Обробка з'єднання та сталість

# Обробка з'єднання та сталість

> **Примітка**: На Unix, драйвер MongoDB чутливий до сценаріїв,
> які використовують системний виклик fork() без наступного exec().
> Користувачам рекомендується не перевикористовувати екземпляр
> [MongoDB\Driver\Manager](class.mongodb-driver-manager.md) у дочірньому
> процесі. child process.

## Постійність підключення та топології (версія PHP починаючи з 1.2.0)

Усі версії драйвера, починаючи з 1.2.0, зберігають клієнтський об'єкт
[» libmongoc](https://github.com/mongodb/mongo-c-driver) у робочому
процесі PHP, що дозволяє йому повторно використовувати з'єднання з базою
даних, стану аутентифікації *і* інформацію про топологію в кількох
запити.

Коли викликається
[MongoDB\Driver\Manager::\_\_construct()](mongodb-driver-manager.construct.md),
з його аргументів створюється хеш (тобто рядок URI та параметри масиву).
Драйвер спробує знайти раніше збережений клієнтський об'єкт
[» libmongoc](https://github.com/mongodb/mongo-c-driver) для цього хеша.
Якщо існуючий клієнт не може бути знайдено для хеша, буде створено
новий клієнт (і збережено для майбутнього використання).

Кожен клієнт містить свої власні підключення до бази даних та
представлення топології сервера (наприклад, автономний, набір реплік,
кластер сегментів). Зберігаючи клієнт між запитами PHP, драйвер може
повторно використовувати встановлені підключення до бази даних та
усувати необхідність [» виявлення топології
сервера](https://github.com/mongodb/specifications/blob/master/source/server-discovery-and-monitoring/server-discovery-and-monitoring.rst)
при кожному запиті.

Розглянемо наступний приклад:

`<?php$managers u003d [   new MongoDB\Driver\Manager('mongodb://127.0.0.1'),    new MongoDB\Driver\Manager('mongodb://127.0.0.1'),    ('mongodb://127.0.0.1:27017'),   new MongoDB\Driver\Manager('mongodb://rs1.example.com,rs2.example.com/', ['replicaSet' u003d> 'myReplicaSet'] ),];foreach ($managers as $manager) {   $manager->executeCommand('test', new MongoDB\Driver\Command(['ping' u003d> 1]));}?> `

Перші два об'єкти Manager будуть використовувати один і той самий клієнт
[» libmongoc](https://github.com/mongodb/mongo-c-driver), оскільки їх
аргументи конструктора ідентичні. Третій та четвертий об'єкти будуть
використовувати кожний свій клієнт. Всього буде створено три клієнти, та
процес PHP, що виконує цей скрипт, відкриє два з'єднання
`127.0.0.1` та одне з'єднання з кожним з `rs1.example.com` та
`rs2.example.com`. Якщо драйвер виявляє додаткових членів
набору реплік після виконання команд `hello`, він також відкриває
додаткові підключення до цих серверів.

Якщо цей процес знову виконає сценарій у другому запиті, ці три
клієнта будуть використані повторно, і нові підключення не будуть
виконуватись. Залежно від того, як давно було оброблено попередній
запит, драйверу може знадобитися виконати додаткові команди
`hello` для оновлення власного представлення топологій.

## Постійність сокетів (версії PHP до 1.2.0)

Версії драйвера PHP до 1.2.0 використовують PHP's Streams API для з'єднань
з базою даних, використовуючи API в
[» libmongoc](https://github.com/mongodb/mongo-c-driver) для визначення
користувальницьких обробників для зв'язку із сокетами; однак новий клієнт
libmongoc створюється для кожного
[MongoDB\Driver\Manager](class.mongodb-driver-manager.md). В
в результаті драйвер зберігає окремі з'єднання з базою даних, але не
інформацію про стан автентифікації чи топології. Це означає, що
драйвер повинен видавати команди на початку кожного запиту для перевірки
справжності та [» виявлення топології
сервера](https://github.com/mongodb/specifications/blob/master/source/server-discovery-and-monitoring/server-discovery-and-monitoring.rst).

З'єднання з базою даних зберігаються за допомогою хеша, отриманого з
хоста, порту та рядки URI сервера, що використовується для побудови
[MongoDB\Driver\Manager](class.mongodb-driver-manager.md). Параметри
масив конструктора не включені в цей хеш.

> **Примітка**: Версії драйвер \>u003d 1.1.8 and \< 1.2.0 не зберігають
> сокети для з'єднань SSL. Дивіться
> [» PHPC-720](https://jira.mongodb.org/browse/PHPC-720) для отримання
> Додаткову інформацію.

Незважаючи на недоліки, пов'язані зі збереженням з'єднань SSL та
інформацією про топологію, ця версія драйвера підтримує всі [параметри
контексту SSL](context.ssl.md), оскільки використовує PHP's Streams
API.
