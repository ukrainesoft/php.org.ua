- [«filetype](function.filetype.md)
- [fnmatch »] (function.fnmatch.md)

- [PHP Manual](index.md)
- [Функції файлової системи](ref.filesystem.md)
- Портоване консультативне блокування файлів

# flock

(PHP 4, PHP 5, PHP 7, PHP 8)

flock — Портоване консультативне блокування файлів

### Опис

**flock**(resource `$stream`, int `$operation`, int `&$would_block` u003d
**`null`**): bool

**flock()** дозволяє здійснити просту модель читання/запису, яка
може бути використана практично на будь-якій платформі (включаючи
більшість варіантів Unix і навіть Windows).

Блокування також знімається за допомогою [fclose()](function.fclose.md)
або коли `stream` збирається збирачем сміття.

PHP підтримує портований спосіб консультативного блокування (advisory
locking) повністю всього файлу (що означає, що всі програми,
здійснюють доступ до файлу, повинні використовувати той самий спосіб
блокування, інакше блокування не працюватиме). За замовчуванням дана
функція чекатиме отримання блокування; цю поведінку можна змінити з
за допомогою описаного нижче параметра **`LOCK_NB`**.

### Список параметрів

`stream`
Вказівник (resource) на файл, який зазвичай створюється за допомогою функції
[fopen()](function.fopen.md).

`operation`
`operation` може приймати такі значення:

- **`LOCK_SH`** для отримання блокування (читання).
- **`LOCK_EX`** для отримання ексклюзивного блокування (запис).
- **`LOCK_UN`** для зняття блокування (розділюваного або ексклюзивного).

Також можна додати константу **`LOCK_NB`** як бітову маску
до будь-якої з вищезгаданих операцій, якщо **flock()** не повинна
блокуватись під час спроби блокування.

`would_block`
Необов'язковий третій параметр буде встановлено в 1, якщо блокування
буде блокуючою (код помилки EWOULDBLOCK).

### Значення, що повертаються

Повертає **`true`** у разі успішного виконання або **`false`** у
у разі виникнення помилки.

### Приклади

**Приклад #1 Приклад використання функції **flock()****

` <?php$fp u003d fopen("/tmp/lock.txt", "r+");if (flock($fp, LOCK_EX)) { // виконуємо ексклюзивне блокування    ftruncate($fp, 0 // очищаємо файл    fwrite($fp, "Що-небудь пишем|сюди
");  fflush($fp);        // очищаємо виведення перед скасуванням блокування    flock($fp, LOCK_UN); // знімаємо блокування! 

**Приклад #2 Використання **flock()** з параметром **`LOCK_NB`****

` <?php$fp u003d fopen('/tmp/lock.txt', 'r+');/* Включаємо параметр LOCK_NB в операції LOCK_EX */if(!flock($fp, LOCK_EX  LOCK_N вдалося отримати блокування'; exit(-1);}/* ... */fclose($fp);?> `

### Примітки

> **Примітка**:
>
> У Windows **flock()** використовує обов'язкове (mandatory) блокування
> замість консультативної. Обов'язкове блокування також підтримується
> на Linux та операційних системах, заснованих на System V за допомогою
> стандартний механізм, який надає системний виклик fcntl():
> тобто шуканий файл повинен мати встановлений біт доступу setgid
> невстановлений біт групового виконання. Для коректної роботи цієї
> схеми в Linux, файлова система також має бути змонтована з
> Опцією mand.

> **Примітка**:
>
> Через те, що функції **flock()** необхідний покажчик файлу, вам
> може знадобитися скористатися спеціальним замикаючим файлом для
> щоб обмежити доступ до файлу, який ви маєте намір очищати,
> шляхом його відкриття в режимі запису (використовуючи "w" або "w+" як
> аргумент функції [fopen()](function.fopen.md)).

> **Примітка**:
>
> Може використовуватись тільки на дескрипторах локальних файлів,
> повернутих функцією [fopen()](function.fopen.md), або файлових
> дескриптори користувача потоків, що реалізують метод
> [streamWrapper::stream_lock()](streamwrapper.stream-lock.md).

**Увага**

Присвоєння іншого значення аргументу `stream` у наступному коді
скасує існуюче блокування.

**Увага**

У деяких операційних системах **flock()** реалізовано на рівні
процесів. При використанні багатопотокових серверних API, таких як
ISAPI, ви не можете покладатися на **flock()** для захисту ваших файлів від
інших PHP-скриптів, які працюють у паралельному потоці на тому ж
сервері!

**flock()** не підтримується на старих файлових системах на зразок `FAT` і
її похідних, так що завжди буде повертати **`false`** у цих
оточення.

> **Примітка**:
>
> У Windows, якщо процес блокування відкриває файл вдруге, він не
> може отримати доступ до файлу через другий дескриптор, доки він не
> розблокує файл.
