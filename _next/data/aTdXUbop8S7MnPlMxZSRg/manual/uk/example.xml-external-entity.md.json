{"pageProps":{"page":{"slug":"example.xml-external-entity.md","content":"## Приклад використання зовнішніх сутностей XML\n\nЦей приклад підсвічує XML-код. Він ілюструє те, як необхідно використовувати обробник посилання на зовнішню сутність для підключення і аналізу вмісту зовнішніх файлів, так само як може бути оброблений PI, і шлях для визначення \"довіри\" до коду, що міститься в PI.\n\nXML документи, які використовуються в прикладі, розташовані під самим прикладом (xmltest.xml і xmltest2.xml.)\n\n**Приклад #1 Приклад використання зовнішньої сутності**\n\n```php\n<?php\n$file = \"xmltest.xml\";\n\nfunction trustedFile($file)\n{\n    // доверять только нашим собственным локальным файлам\n    if (!preg_match(\"@^([a-z][a-z0-9+.-]*)\\:\\/\\/@i\", $file)\n        && fileowner($file) == getmyuid()) {\n            return true;\n    }\n    return false;\n}\n\nfunction startElement($parser, $name, $attribs)\n{\n    echo \"&lt;<font color=\\\"#0000cc\\\">$name</font>\";\n    if (count($attribs)) {\n        foreach ($attribs as $k => $v) {\n            echo \" <font color=\\\"#009900\\\">$k</font>=\\\"<font\n                   color=\\\"#990000\\\">$v</font>\\\"\";\n        }\n    }\n    echo \"&gt;\";\n}\n\nfunction endElement($parser, $name)\n{\n    echo \"&lt;/<font color=\\\"#0000cc\\\">$name</font>&gt;\";\n}\n\nfunction characterData($parser, $data)\n{\n    echo \"<b>$data</b>\";\n}\n\nfunction PIHandler($parser, $target, $data)\n{\n    switch (strtolower($target)) {\n        case \"php\":\n            global $parser_file;\n            // Если обработанный документ является \"доверенным\", то можно сказать,\n            // что запуск расположенного в нем кода является безопасным. Если нет,\n            // то вместо запуска отобразить сам код.\n            if (trustedFile($parser_file[$parser])) {\n                eval($data);\n            } else {\n                printf(\"Небезопасный код PHP: <i>%s</i>\",\n                        htmlspecialchars($data));\n            }\n            break;\n    }\n}\n\nfunction defaultHandler($parser, $data)\n{\n    if (substr($data, 0, 1) == \"&\" && substr($data, -1, 1) == \";\") {\n        printf('<font color=\"#aa00aa\">%s</font>',\n                htmlspecialchars($data));\n    } else {\n        printf('<font size=\"-1\">%s</font>',\n                htmlspecialchars($data));\n    }\n}\n\nfunction externalEntityRefHandler($parser, $openEntityNames, $base, $systemId,\n                                  $publicId) {\n    if ($systemId) {\n        if (!list($parser, $fp) = new_xml_parser($systemId)) {\n            printf(\"Невозможно открыть сущность %s в %s\\n\", $openEntityNames,\n                   $systemId);\n            return false;\n        }\n        while ($data = fread($fp, 4096)) {\n            if (!xml_parse($parser, $data, feof($fp))) {\n                printf(\"Ошибка XML: %s в строке %d в процессе разбора сущности %s\\n\",\n                       xml_error_string(xml_get_error_code($parser)),\n                       xml_get_current_line_number($parser), $openEntityNames);\n                xml_parser_free($parser);\n                return false;\n            }\n        }\n        xml_parser_free($parser);\n        return true;\n    }\n    return false;\n}\n\nfunction new_xml_parser($file)\n{\n    global $parser_file;\n\n    $xml_parser = xml_parser_create();\n    xml_parser_set_option($xml_parser, XML_OPTION_CASE_FOLDING, 1);\n    xml_set_element_handler($xml_parser, \"startElement\", \"endElement\");\n    xml_set_character_data_handler($xml_parser, \"characterData\");\n    xml_set_processing_instruction_handler($xml_parser, \"PIHandler\");\n    xml_set_default_handler($xml_parser, \"defaultHandler\");\n    xml_set_external_entity_ref_handler($xml_parser, \"externalEntityRefHandler\");\n\n    if (!($fp = @fopen($file, \"r\"))) {\n        return false;\n    }\n    if (!is_array($parser_file)) {\n        settype($parser_file, \"array\");\n    }\n    $parser_file[$xml_parser] = $file;\n    return array($xml_parser, $fp);\n}\n\nif (!(list($xml_parser, $fp) = new_xml_parser($file))) {\n    die(\"Чтение XML-файла невозможно\");\n}\n\necho \"<pre>\";\nwhile ($data = fread($fp, 4096)) {\n    if (!xml_parse($xml_parser, $data, feof($fp))) {\n        die(sprintf(\"Ошибка XML: %s в строке %d\\n\",\n                    xml_error_string(xml_get_error_code($xml_parser)),\n                    xml_get_current_line_number($xml_parser)));\n    }\n}\necho \"</pre>\";\necho \"разбор завершён\\n\";\nxml_parser_free($xml_parser);\n\n?>\n```\n\n**Приклад #2 xmltest.xml**\n\n\\]> Title &plainEntity; a1b1c1 a2c2 a3b3c3 &systemEntity;\n\nAbout this Document\n\nЦей файл підключено до xmltest.xml:\n\n**Приклад #3 xmltest2.xml**\n\n\\]> &testEnt;\n","title":"Приклад використання зовнішніх сутностей XML","contentType":2,"navigation":[{"example.xml-map-tags.md":"« Приклад відображення тегів XML"},{"ref.xml.md":"Функції парсера XML »"},{"index.md":"PHP Manual"},{"xml.examples.md":"Приклади"}]}},"__N_SSG":true}