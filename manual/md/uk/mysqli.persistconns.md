- [« Типи ресурсів](mysqli.resources.md)
- [Предвизначені константи »](mysqli.constants.md)

- [PHP Manual](index.md)
- [MySQLi](book.mysqli.md)
- Модуль mysqli та постійні з'єднання

# Модуль mysqli та постійні з'єднання

Ідея постійних підключень полягає в тому, щоб з'єднання між
клієнтським процесом та базою даних можна було використовувати повторно,
особливо коли потрібно створювати та закривати з'єднання безліч разів.
Це дозволило б знизити накладні витрати на створення нових підключень
щоразу, коли вони потрібні, за рахунок використання існуючих
кешованих підключень, вільних для повторного використання.

На відміну від модуля mysql, mysqli немає окремої функції для створення
постійних з'єднань. Щоб відкрити постійне з'єднання, під час створення
підключення до імені хоста потрібно додати префікс `p:`.

При використанні постійних з'єднань можна зіткнутися з проблемою,
яка полягає в тому, що клієнти можуть залишати такі підключення
у непередбачуваному стані. Наприклад, клієнт ставить блокування на
таблицю, а потім аварійно завершує роботу. Тобто блокування знято не
буде. Новий клієнтський процес, який використовує це підключення повторно,
отримає його "як є", і змушений буде провести якесь очищення
підключення, перш ніж почати використовувати його. Відповідно, в
завдання програміста входить ще й перевірка подібних ситуацій та впровадження
коду, що здійснює таку очистку.

Тим не менш, в `mysqli` ця проблема вирішена. У модулі є вбудований
функціонал, що здійснює очищення з'єднань і перекладає їх у
стан придатний для використання. Код очищення, реалізований у
`mysqli` включає наступні операції:

- Відкат активних транзакцій

- Закриття та видалення тимчасових таблиць

- Зняття блокування з таблиць

- Скидання змінних сесії

- Закриття підготовлених запитів (завжди відбувається у PHP)

- Закриття обробників

- Зняття блокувань, встановлених функцією **GET_LOCK()**

Це дозволяє бути впевненим у тому, що повернені з пулу з'єднання
готові до використання у клієнтських процесах.

Модуль `mysqli` робить очищення з'єднань автоматично шляхом виклику
C-API функції `mysql_change_user()`.

Автоматичне очищення має свої переваги та недоліки. Як плюс,
програмісту більше не треба дбати про очищення з'єднання, все
робиться автоматично. Однак, це не найкращим чином впливає на
продуктивність, скрипт "потенційно" може працювати повільніше, так
як автоматичне чищення запускається кожен раз, коли з'єднання
вилучається з пулу.

Є можливість вимкнути автоматичне очищення з'єднань, якщо
скомпілювати PHP з директивою **`MYSQLI_NO_CHANGE_USER_ON_PCONNECT`**.

> **Примітка**:
>
> Постійні з'єднання підтримуються модулем `mysqli` як під час роботи з
> рідним MySQL-драйвером, так і під час роботи з клієнтською бібліотекою
> MySQL.
