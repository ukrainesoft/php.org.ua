- [« Приклади](oci8.examples.md)
- [Підтримка OCI8 Fast Application Notification (FAN)
»](oci8.fan.md)

- [PHP Manual](index.md)
- [OCI8](book.oci8.md)
- Робота зі з'єднаннями OCI8 та Connection Pooling

# Робота зі з'єднаннями OCI8 та Connection Pooling

## Функції підключення

Модуль OCI8 надає три різні функції для підключення до
серверу Oracle. Стандартна функція з'єднання - це
[oci_connect()](function.oci-connect.md). Вона створює з'єднання до
базі даних Oracle і повертає ресурс, який використовується при
наступних зверненнях до БД.

Підключення до сервера Oracle є досить дорогою операцією
з точки зору часу, який потрібний для виконання. Функція
[oci_pconnect()](function.oci-pconnect.md) використовує постійний кеш
з'єднань, які можуть бути повторно використані різними
запитами скриптів. Це означає, що витрати на встановлення з'єднання,
як правило, відбуваються лише один раз на один процес PHP (або на
нащадка Apache).

Якщо програма з'єднується з сервером Oracle, використовуючи спеціальний набір
даних для кожного веб-користувача, то постійний кеш з'єднань,
використовуваний функцією [oci_pconnect()](function.oci-pconnect.md) буде
менш корисним, т.к. кількість одночасних користувачів зростає до
того рівня, де він може почати негативно впливати на загальну
продуктивність сервера Oracle через підтримку занадто великого
кількості з'єднань, що простоюють. Якщо програма налаштована такою
рекомендується або налаштувати його за допомогою параметрів
конфігурації
[oci8.max_persistent](oci8.configuration.md#ini.oci8.max-persistent) та
[oci8.persistent_timeout](oci8.configuration.md#ini.oci8.persistent-timeout)
(це дасть можливість керування розміром кешу постійних з'єднань та
їх час життя), або використовувати Oracle Database Resident Connection
Pooling (в Oracle Database 11g і новіше), або використовувати функцію
[oci_connect()](function.oci-connect.md) замість неї.

Водночас [oci_connect()](function.oci-connect.md) та
[oci_pconnect()](function.oci-pconnect.md) використовують кеш підключень;
якщо багато дзвінків [oci_connect()](function.oci-connect.md)
використовує однакові параметри в даному скрипті, другий та наступні
дзвінки повернуть існуючий дескриптор з'єднання. Кеш, використовуваний
функцією [oci_connect()](function.oci-connect.md), очищається за
завершення виконання скрипта або коли з'єднання неявно закривається.
У функції [oci_pconnect()](function.oci-pconnect.md) схоже
поведінка, хоча її кеш обробляється окремо і залишається чинним
між запитами HTTP

Ця можливість кешування означає, що два дескриптори не ізольовані
транзакційно (вони насправді є одним і тим же дескриптором,
тому тут немає жодної ізоляції. Якщо програмі необхідні два
окремих транзакційно ізольованих з'єднань, то необхідно
використовувати функцію [oci_new_connect()](function.oci-new-connect.md).

Кеш функції [oci_pconnect()](function.oci-pconnect.md) очищається і
закриваються всі з'єднання БД, коли завершується процес PHP. Тому
ефективне використання постійних з'єднань вимагає, щоб PHP був
модулем Apache або використовувався з FPM або подібним. Постійні
з'єднання не матимуть жодних переваг перед
[oci_connect()](function.oci-connect.md), коли PHP використовується з CGI
або через командний рядок.

Функція [oci_new_connect()](function.oci-new-connect.md) завжди
створює нове з'єднання з сервером Oracle, незважаючи на те, що інші
з'єднання можуть існувати. Високонавантаженим веб-додаткам
слід уникати використання
[oci_new_connect()](function.oci-new-connect.md), особливо у самих
завантажених частинах програми.

Починаючи з OCI8 1.3, постійні з'єднання можуть бути закриті
користувачем, що дає більш повний контроль за використанням
ресурсів. Також постійні з'єднання можуть бути закриті автоматично,
якщо не залишилося змінних PHP, що вказують на них, наприклад при
завершення виконання функції користувача. Закриття з'єднання
відкотить усі підтверджені транзакції. Ці зміни в постійних
підключеннях роблять їхню поведінку аналогічною не постійним з'єднанням.
Щоб увімкнути стару поведінку, задайте опцію
[oci8.old_oci_close_semantics](oci8.configuration.md#ini.oci8.old-oci-close-semantics)
значенням * On *.

Автоматичне перестворення постійних з'єднань після перезапуску
процесів Apache або FPM, означає, що Oracle Database `LOGON`
рекомендується лише для налаштування атрибутів сеансу, а не для запитів
на підключення користувачів для окремих програм.

## Створення пулу з'єднань DRCP

PHP починаючи з 5.3 (PECL OCI8 1.3) підтримує постійний пул з'єднань
Oracle 11g (DRCP). DRCP дозволяє ефективніше використовувати пам'ять
СУБД і надає високу масштабованість. Змінювати код програми
для використання DRCP або немає потреби, або потрібні
мінімальні зміни.

DRCP підходить для програм, які підключаються за допомогою декількох
схем БД та зберігають з'єднання до БД відкритими короткий проміжок
часу. Іншим програмам слід використовувати доступні за замовчуванням
`Dedicated` серверні процеси або використовувати `Shared` сервера.

DRCP приносить користь усім трьом функціям підключення, проте
надає найвищу масштабованість, коли з'єднання створюються
за допомогою функції [oci_pconnect()](function.oci-pconnect.md).

Щоб функціональність DRCP була доступна в OCI8, клієнтські бібліотеки
Oracle, що використовуються в PHP, і версія сервера баз даних повинні бути 11g
та новіше.

Документація з DRCP знаходиться в кількох посібниках Oracle. До
Наприклад, дивіться [»Конфігурування пулу постійних з'єднань бази
даних](https://www.oracle.com/pls/topic/lookup?ctxu003ddblatest&idu003dGUID-82FF6896-F57E-41CF-89F7-755F3BC9C924)
у документації Oracle для інформації щодо використання. Документ
[" технічний опис
DRCP](https://www.oracle.com/technetwork/topics/php/whatsnew/php-scalability-ha-twp-128842.pdf)
містить додаткову інформацію щодо DRCP.

Для використання DRCP, встановіть модуль OCI8 1.3 (або новий) і
бібліотеки Oracle 11g (або новіші) і потім виконайте такі дії:

- Як привілейований адміністратор БД скористайтесь програмою
на зразок SQL\*Plus, щоб запустити пул з'єднань у СУБД:

SQL> execute dbms_connection_pool.start_pool;

- Додатково можна використовувати
`dbms_connection_pool.alter_param()`, щоб конфігурувати
Параметри DRPC. Поточні налаштування пулу можуть бути отримані з
уявлення `DBA_CPOOL_INFO`.

- Оновіть рядок з'єднання. Наприклад, для додатків
PHP, які зараз з'єднуються, використовуючи Network Connect Name
`MYDB`:

$c u003d oci_pconnect("myuser", "mypassword", "MYDB");

змініть файл tnsnames.ora та додайте оператор `(SERVERu003dPOOLED)`,
наприклад:

MYDB u003d (DESCRIPTIONu003d(ADDRESSu003d(PROTOCOLu003dtcp)) (HOSTu003dmyhost.dom.com)
(PORTu003d1521))(CONNECT_DATAu003d(SERVICE_NAMEu003dsales)
(SERVER u003d POOLED)))

Як альтернативу можна змінити синтаксис спрощеного
з'єднання в PHP і додати туди `:POOLED` після імені сервісу:

$c u003d oci_pconnect("myuser", "mypassword", "myhost.dom.com:1521/sales:POOLED");

- Відредагуйте `php.ini` та виберіть ім'я класу з'єднання. Це ім'я
встановлює логічне поділ пулу сполук і може
використовуватися, щоб ізолювати пул для окремих програм.
Будь-яке PHP-додаток з однаковим ім'ям користувача та класом для
з'єднання буде мати можливість спільно використовувати з'єднання
в пулі, отримуючи більшу масштабованість.

oci8.connection_class u003d "MY_APPLICATION_NAME"

- Запустіть програму, що з'єднується з базою 11g та новішою.

> **Примітка**:
>
> Програми, які використовують Oracle 10g, які вимагають
> продуктивності від постійних з'єднань можуть зменшити
> кількість пам'яті сервера БД, яка використовується `Shared`-серверами
> Oracle (раніше відомі як багатопотокові сервери). Зверніться до
> документації Oracle для більш детальної інформації.

> **Примітка**:
>
> При зміні пароля через з'єднання DRCP буде видаватися помилка
> *ORA-56609: Usage not supported with DRCP*. Це документоване
> обмеження Oracle Database 11g.
