- [«Підключення та керування підключеннями](pdo.connections.md)
- [Підготовлені запити та процедури, що зберігаються
»](pdo.prepared-statements.md)

- [PHP Manual](index.md)
- [PDO](book.pdo.md)
- транзакції та автоматична фіксація змін

# Транзакції та автоматична фіксація змін

Тепер ви знаєте, як підключатися до баз даних за допомогою PDO. Але
перед тим, як виконувати запити, вам необхідно зрозуміти, як PDO
керує транзакціями. Якщо ви раніше не стикалися з транзакціями,
вони володіють чотирма головними властивостями, це Атомарність,
Узгодженість, ізольованість і довговічність (ACID). Говорячи простим
мовою, будь-які дії, вчинені в рамках транзакції, гарантовано
будуть виконані безпечно для бази даних, і на них не вплинуть інші
підключення до цієї бази, навіть якщо ці дії здійснюються в кілька
етапів. Транзакційні операції можна скасовувати на запит (якщо
транзакція ще не зафіксована), що спрощує обробку помилок у
скриптів.

Механізм транзакцій реалізований шляхом "тимчасового збереження" всіх
змін та подальшого застосування цих змін, як єдиного цілого.
Це дозволяє досягти різкого збільшення ефективності подібних
змін. Іншими словами, транзакції можуть зробити ваші скрипти.
швидкими та потенційно більш стабільними (але для цього необхідно
коректно використати цей механізм.

На жаль, не всі бази даних підтримують транзакції, тому PDO при
створення підключення працює в режимі так званої "автоматичної"
фіксації". Режим автофіксації означає, що кожен запит до бази даних,
який ви виконуєте, неявно полягає в транзакції, якщо СУБД їх
підтримує. Якщо база даних не підтримує цей механізм, запит
обробляється без транзакції. Щоб явно позначити початок транзакції,
ви повинні використовувати метод
[PDO::beginTransaction()](pdo.begintransaction.md). Якщо драйвер не
підтримує механізм транзакцій, буде викинуто виключення
PDOException (незалежно від обраного способу обробки помилок:
подібні ситуації - це завжди серйозна недоробка). Після того як
ви здійсните транзакцію, ви можете зафіксувати її методом
[PDO::commit()](pdo.commit.md) або відкотити методом
[PDO::rollBack()](pdo.rollback.md), в залежності від того, успішно
виконано ваш код усередині транзакції чи ні.

**Увага**

PDO перевіряє можливість використання транзакцій лише на рівні
драйвера. Якщо з якихось причин механізм транзакцій недоступний, але
сервер баз даних прийняв запит на відкриття транзакції,
[PDO::beginTransaction()](pdo.begintransaction.md) поверне **`true`**
без помилок.

Як приклад може бути спроба використання транзакцій у
таблиці MyISAM бази даних MySQL.

При завершенні роботи скрипта або при закритті з'єднання PDO
автоматично відкочує всі незавершені транзакції. Це робиться,
щоб запобігти порушенням цілісності бази даних у випадках, коли
скрипт несподівано перериває роботу. Якщо ви явно не зафіксували
Зміна передбачається, що щось пішло не так. Тому відкат
змін - найбезпечніший вихід із ситуації.

**Увага**

Зміни будуть відкачані автоматично, тільки якщо транзакція відкрита
методом [PDO::beginTransaction()](pdo.begintransaction.md). Якщо
транзакцію відкрити вручну в тексті запиту, PDO про це не
дізнається, і, відповідно, не зможе вжити заходів, якщо станеться щось
погане.

**Приклад #1 Виконання пакета змін у рамках транзакції**

У наступному прикладі припустимо, що ми створюємо кілька записів для
нового співробітника з номером ID 23. Крім введення основної інформації
необхідно записати його зарплатню. Досить просто зробити два окремі
оновлення таблиць, однак шляхом укладання цих запитів у рамки
[PDO::beginTransaction()](pdo.begintransaction.md) та
[PDO::commit()](pdo.commit.md) ми зможемо гарантувати, що ніхто не
побачить цих змін, доки всі вони не будуть завершені. Якщо щось
піде не так, catch-блок відкотить усі зміни з початку транзакції та
друкує повідомлення про помилку.

` <?phptry { $dbh u003d new PDO('odbc:SAMPLE', 'db2inst1', 'ibmdb2',      array(PDO::ATTR_PERSISTENT u003d> true)); echo "Підключилися
";} catch (Exception $e) { die("Не удалося підключитися: " . $e->getMessage());}try { $dbh->setAttribute(PDO::ATTR_ERRMODE, PDO: $: ->beginTransaction();$dbh->exec("insert into staff (id, first, last) values (23, 'Joe', 'Bloggs')"); $dbh->exec("insert , amount, changedate)       values (23, 50000, NOW())"); $dbh->commit();} catch (Exception $e) { о"d| ->getMessage();}?> `

Ви не обмежені у кількості запитів у рамках транзакції; ви
також можете виконувати складні запити, щоб отримати дані, а потім
використовувати їх для створення інших запитів на оновлення та вилучення
даних; якщо транзакція активна, ви можете бути впевнені, що ніхто не
зможе змінити ваші дані, доки ви з ними працюєте. За додатковою
інформацією про транзакції звертайтесь до документації до вашого сервера
баз даних.
